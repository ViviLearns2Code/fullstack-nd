"use strict";var mapModule=function(){var t,e,n,a,o=new Map,r=sharedData.getLocations(),i=function(e){var a,r,i=[],s={},u=[],c="",d="",l=function(t){return'<img src="'+t.icon+'">'+t.city+"<br>\n\t\t\t\t\t"+t.text+"<br>\n\t\t\t\t\t"+t.temp+"&deg;C"},g=function(t){return"<ul>\n\t\t\t\t\t"+t.map(function(t){for(var e=Math.round(t.distance),n="",a=0;a<Math.floor(t.rating);a++)n+='<i class="fa fa-star" aria-hidden="true"></i>';return t.rating!==Math.floor(t.rating)&&(n+='<i class="fa fa-star-half-o" aria-hidden="true"></i>'),'<li><a href="'+t.url+'" target="_blank">'+t.name+"</a>\n\t\t\t\t\t\t<br>Rating: "+n+"\n\t\t\t\t\t\t("+t.review_count+" reviews)\n\t\t\t\t\t\t\t<br>"+t.address+" ("+e+" meters)</li>"}).join("")+"\n\t\t\t\t\t</ul>"},m=function(t,e,n){return'<div class="info-window">'+t.name+"<br>\n\t\t\t\t\t\t<h4>Weather</h4>\n\t\t\t\t\t\t"+e+"\n\t\t\t\t\t\t<h4>Nearby Restaurants</h4>\n\t\t\t\t\t\t"+n+"\n\t\t\t\t\t\t</div>"};a=function(t){return $.ajax({url:"http://api.openweathermap.org/data/2.5/weather",type:"GET",data:{lat:t.coord.lat,lon:t.coord.lng,APPID:weatherAPIKey,units:"metric"},dataType:"json"})}(e),r=function(t){return $.get({url:"/getYelpAPI",type:"GET",data:{latitude:t.coord.lat,longitude:t.coord.lng,radius:1e3,categories:["Restaurants"],limit:5,sort_by:"rating"},dataType:"json"})}(e),u.push(a,r),a.then(function(t,e,n){"success"===e&&(s={icon:"http://openweathermap.org/img/w/"+t.weather[0].icon+".png",city:t.name,coord:{lat:t.coord.lat,lon:t.coord.lon},text:t.weather[0].description,temp:t.main.temp,humidity:t.main.humidity,pressure:t.main.pressure,wind:t.wind.speed},d=l(s))},function(t,e,n){d="Could not retrieve weather data: "+n}),r.then(function(t,e,n){if("success"===e){for(var a=0;a<Math.min(5,t.businesses.length);a++){var o=t.businesses[a],r={};r.name=o.name,r.url=o.url,r.review_count=o.review_count,r.rating=o.rating,r.img=o.image_url,r.address=o.location.address1,r.distance=o.distance,r.coordinates={lat:o.coordinates.latitude,lng:o.coordinates.longitude},i.push(r)}c=g(i)}},function(t,e,n){c="Could not retrieve restaurant data: "+n}),Promise.all(u.map(function(t){return t.then(function(){return{state:"resolved"}},function(){return{state:"rejected"}})})).then(function(){n&&n.close();var a=o.get(e.name);n.setContent(m(e,d,c)),n.open(t,a)})},s=function(t){u(this.title)},u=function(e){var n=o.get(e);t.setCenter(n.getPosition()),n.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){n.setAnimation(null)},1500),r.forEach(function(t){t.name!==e||i(t)})};return{init:function(){a=ViewModel,t=new google.maps.Map(document.getElementById("map"),{center:{lat:0,lng:0},styles:[{stylers:[{saturation:10},{lightness:0}]}]}),n=new google.maps.InfoWindow,e=new google.maps.LatLngBounds,r.forEach(function(n){var a=new google.maps.Marker({map:t,position:n.coord,title:n.name,icon:"images/tree.png"});google.maps.event.addListener(a,"click",s),o.set(n.name,a),e.extend(n.coord)}),t.fitBounds(e),t.setCenter(e.getCenter()),google.maps.event.addDomListener(window,"resize",function(){var a=t.getCenter();google.maps.event.trigger(t,"resize"),t.setCenter(a),t.fitBounds(e),n.getContent()&&""!==n.getContent()&&(n.close(),n.open(t))})},onFilter:function(a){n&&(n.close(),n.setContent(void 0)),e=new google.maps.LatLngBounds,r.forEach(function(n){!0===a.get(n.name)?o.get(n.name).setMap(null):o.get(n.name).setMap(t),e.extend(n.coord)}),t.fitBounds(e),t.setCenter(e.getCenter())},handleMarker:u,mapResize:function(){google.maps.event.trigger(t,"resize")}}}();